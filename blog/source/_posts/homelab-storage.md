---
title: HomeLab系列（三） - 存储（上）
date: 2022-11-13 22:13:39
tags:
---

# HomeLab存储如何搭建（上）

## 存储类型

### 块设备

　　什么是块设备？Copilot是这么说的：块设备就是一个个的块，每个块都有一个编号，这个编号就是块的地址，块设备就是把这些块按照顺序组织起来，形成一个个的块设备。块设备的特点是：块设备的大小是固定的，块设备的大小是由块的大小和块的数量决定的。百度百科是这么说的：

    块设备是i/o设备中的一类，是将信息存储在固定大小的块中，每个块都有自己的地址，还可以在设备的任意位置读取一定长度的数据，例如硬盘,U盘，SD卡等。


### 文件系统

　　什么是文件系统？Copilot是这么说的：文件系统是一种把块设备组织成文件的方式。百度百科是这么说的：

    文件系统是操作系统用于明确存储设备（常见的是磁盘，也有基于NAND Flash的固态硬盘）或分区上的文件的方法和数据结构；即在存储设备上组织文件的方法。操作系统中负责管理和存储文件信息的软件机构称为文件管理系统，简称文件系统。文件系统由三部分组成：文件系统的接口，对对象操纵和管理的软件集合，对象及属性。从系统角度来看，文件系统是对文件存储设备的空间进行组织和分配，负责文件存储并对存入的文件进行保护和检索的系统。具体地说，它负责为用户建立文件，存入、读出、修改、转储文件，控制文件的存取，当用户不再使用时撤销文件等。
    
### 介绍这俩有什么意义

　　通常来讲，我们使用的存储设备都是块设备，比如硬盘、U盘、SD卡等。我们把这些块设备挂载到文件系统上，就可以像操作文件一样操作块设备了。HomeLab的存储共享在不同层次上有不同协议，比如基于块设备的协议有iSCSI等，基于文件系统的协议有NFS、SMB等。

## 存储共享协议

### iSCSI
　　说到iSCSI，那不得不提到SCSI。SCSI接口是一个通用接口，在SCSI母线上可以连接主机适配器和八个SCSI外设控制器，外设可以包括磁盘、磁带、CD-ROM、可擦写光盘驱动器、打印机、扫描仪和通讯设备等。SCSI接口的优点是可以连接多个设备，而且可以通过SCSI总线进行通信，但是SCSI接口的缺点是不支持网络。  

　　iSCSI，Internet小型计算机系统接口，又称为IP-SAN，是一种基于因特网及SCSI-3协议下的存储技术，由IETF提出，并于2003年2月11日成为正式的标准。与传统的SCSI技术比较起来，iSCSI技术有以下三个革命性的变化：
- 把原来只用于本机的SCSI协议透过TCP/IP网络发送，使连接距离可作无限的地域延伸；
- 连接的服务器数量无限（原来的SCSI-3的上限是15）；
- 由于是服务器架构，因此也可以实现在线扩容以至动态部署。  

　　![](/static/images/2022/11/13/1.png)  
　　iSCSI协议实现就很简单，包一层IP头就可以了。但是这东西不是万能的，iSCSI协议也有一些问题：由于基于以太网协议需要在用户态和内核态拷贝内存，这不仅要占用CPU资源，还会导致IO延迟增大。iSCSI协议的另一个问题是，由于iSCSI协议是基于TCP协议的，所以在网络中传输的数据包会被TCP协议的拥塞控制算法所影响，这会导致iSCSI协议的性能不稳定。  
　　我们可以注意到iSCSI协议是面向块设备的一种协议。因为，你通过iSCSI访问的是硬盘这类块设备。

### NFS
　　百度一下，NFS是基于UDP/IP协议的应用，其实现主要是采用远程过程调用RPC机制，RPC提供了一组与机器、操作系统以及低层传送协议无关的存取远程文件的操作。RPC采用了XDR的支持。XDR是一种与机器无关的数据描述编码的协议，他以独立与任意机器体系结构的格式对网上传送的数据进行编码和解码，支持在异构系统之间数据的传送。  
　　虽然 NFS 是在 UNIX和 Linux 系统中最流行的网络文件系统，但它当然不是唯一的选择。在 Windows系统中，Server Message Block（也称为 CIFS）是最广泛使用的选项（如同 Linux 支持 SMB一样，Windows 也支持 NFS）。
　　我们可以注意到NFS协议是面向文件系统的一种协议。因为，你通过NFS访问的是文件系统。


### SMB/CIFS
　　SMB（Server Message Block）通信协议是微软和英特尔在1987年制定的协议，主要是作为Microsoft网络的通讯协议。SMB 是在会话层和表示层以及小部分应用层的协议。  
　　SMB使用了NetBIOS的应用程序接口。另外，它是一个开放性的协议，允许了协议扩展——使得它变得更大而且复杂；大约有65个最上层的作业，而每个作业都超过120个函数，甚至Windows NT也没有全部支持到，最近微软又把 SMB 改名为 CIFS（Common Internet File System），并且加入了许多新的特色。  
　　我们可以注意到SMB协议也是面向文件系统的一种协议。

## 底层硬件介质
    硬盘有机械硬盘(Hard Disk Drive，HDD)和固态硬盘(SSD)之分。

### HDD
    机械硬盘即是传统普通硬盘，主要由：盘片，磁头，盘片转轴及控制电机，磁头控制器，数据转换器，接口，缓存等几个部分组成。
    磁头可沿盘片的半径方向运动，加上盘片每分钟几千转的高速旋转，磁头就可以定位在盘片的指定位置上进行数据的读写操作。信息通过离磁性表面很近的磁头，由电磁流来改变极性方式被电磁流写到磁盘上，信息可以通过相反的方式读取。硬盘作为精密设备，尘埃是其大敌，所以进入硬盘的空气必须过滤。
　　机械硬盘的主要优势是可以容量大、单价低。尤其是矿难以后，14T/16T的硬盘跌进千元以内，均价最低能达到50元/T。但是，机械硬盘的主要缺点是：读写速度慢、能耗高。首先是，机械硬盘单盘顺序读写普遍在100~200MB/s的级别。其次随机读写性能非常差，受限于磁盘旋转速率是有限的，因此寻道时间通常为毫秒级。同时盘片需要保持旋转，因此即使没有处于读写状态，仍旧有较高的基础功耗。

### SSD
    固态硬盘，因为台湾的英语里把固体电容称为Solid而得名。SSD由控制单元和存储单元（FLASH芯片、DRAM芯片）组成。固态硬盘在接口的规范和定义、功能及使用方法上与普通硬盘的完全相同，在产品外形和尺寸上基本与普通硬盘一致（新兴的U.2，M.2等形式的固态硬盘尺寸和外形与SATA机械硬盘完全不同）。
　　固态硬盘具有传统机械硬盘不具备的快速读写、质量轻、能耗低以及体积小等特点。由于不需要像机械硬盘依赖盘片的旋转进行读写，因此随机读写性能非常好，可以做到10K+ op/s的级别，随机寻道时间可以轻松做到0.1毫秒以下。同时，固态硬盘的读写速度也非常快，顺序读写速度通常在1000MB/s往上。由于没有了磁头电机，SSD依赖NAND芯片进行存储，同样容量下NAND的重量相对较轻，待机功耗也低很多。缺点也很明显，价格高，容量小。目前，SSD的价格在300元/T左右。

## 底层硬件接口

### SATA
    SATA（Serial ATA）是一种串行ATA接口，是一种硬盘接口标准，由Serial ATA International Organization（简称SATA-IO）制定。SATA-IO是一个由硬盘制造商和电脑制造商组成的组织，其目的是制定SATA接口标准。SATA-IO的成员包括AMD、Apple、Dell、Fujitsu、Hitachi、HP、IBM、Intel、Maxtor、Microsoft、NEC、Quantum、Seagate、SiI、Toshiba、Western Digital等。
　　我们通常能买到的HDD，都是基于SATA接口的。当然也有一些企业盘，则是基于SAS接口的。SAS的接口技术可以向下兼容SATA。但是如果你购买了SAS接口的HDD，那你可能就需要另外购买SAS阵列卡，因为大多数主板并不会支持SAS……SAS阵列卡的价格，便宜的型号也在百元上下，同时需要占用PCI-E槽位。  
　　我们在选购机箱的时候，就需要关注机箱有多少硬盘支持。在支持热插拔硬盘的型号里面，背板支持的硬盘类型是否是SATA是我们需要关注的。热插拔的SATA接口允许我们不关机就能够更换硬盘。

### SATA-Express
　　这个你肯定买不到。定位太尴尬从而导致了早夭。  
　　由于SATA速度只有6Gbps，而PCI-E的速度可以达到16Gbps。对于SSD来说，传统SATA接口逐渐成为瓶颈。因此，SATA国际组织选择转向PCI-E，推出了SATA-Express接口。SATA-Express接口的速度可以达到16Gbps。实际上也就是PCI-E x2的速度。他的后继者M.2/U.2都可以做到PCI-E x4的带宽，就显得非常尴尬。

### PCI-E
　　物理形态上，PCI-E SSD有使用传统PCI-E接口的AIC形态，也有走M.2接口、U.2接口的形态。其中，M.2能够同时支持PCI-E通道以及SATA。M.2接口使用M key的时候，可以达到PCI-E x4的速度。M.2的定位是"小型扩展卡"，尺寸和规格如下：

　　![](/static/images/2022/11/13/2.png)  

　　U.2接口又称为SFF-8639，是由固态硬盘形态工作组织推出的介面规范。U.2不但能支持SATA-Express规范，还能相容SAS、SATA等规范。因此大家可以把它当作是四通道版本的SATA-Express接口，它的理论带宽已经达到了32Gbps，与M.2接口毫无差别。但是规格上，U.2接口的设备尺寸则是2.5寸的形态。这就允许U.2接口的设备有更好的散热条件和更大的空间。



